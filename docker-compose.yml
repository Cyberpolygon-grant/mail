# This file is auto-generated by the Mailu configuration wizard.
# Please read the documentation before attempting any change.
# Generated for compose flavor

services:

  # External dependencies
  redis:
    image: redis:alpine
    restart: always
    volumes:
      - "/mailu/redis:/data"

  # Local DNS resolver for offline/local-only operation
  resolver:
    image: jpillora/dnsmasq:latest
    restart: always
    command: ["-k", "--log-facility=-", "--address=/financepro.ru/192.168.203.10", "--address=/mail.financepro.ru/192.168.203.10", "--address=/#/127.0.0.1", "--no-resolv", "--no-poll"]
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      default:
        ipv4_address: 192.168.203.53

  # Core services
  phishing-demo:
    build: .
    restart: always
    environment:
      - TARGET_EMAIL=operator1@financepro.ru
      - SMTP_SERVER=front
      - SMTP_PORT=25
      - ATTACHMENTS_OUTPUT_DIR=/app/sent_attachments
      # Путь к maildir для проверки спама через файловую систему
      - MAIL_DIR=/mailu/mail
      - MAIL_DOMAIN=financepro.ru
      # Параметры IMAP для проверки спама
      - IMAP_SERVER=imap
      - IMAP_PORT=143
      - IMAP_PASSWORD=1q2w#E$R
      # Часовой пояс: UTC+3 (Москва)
      - TZ=Europe/Moscow
    networks:
      - default
    depends_on:
      - front
      - imap
    volumes:
      - "./sent_attachments:/app/sent_attachments"
      # Монтируем maildir для проверки папки Spam
      - "/mailu/mail:/mailu/mail:ro"
    # Временное решение: запуск с правами root для записи в volume
    # Для продакшена лучше исправить права на хосте: chmod 777 sent_attachments
    user: "0:0"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  front:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}nginx:${MAILU_VERSION:-2024.06}
    restart: always
    env_file: mailu.env
    environment:
      - TZ=Europe/Moscow
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    ports:
      - "0.0.0.0:80:80"
      - "0.0.0.0:443:443"
      - "0.0.0.0:25:25"
      - "0.0.0.0:465:465"
      - "0.0.0.0:587:587"
      - "0.0.0.0:110:110"
      - "0.0.0.0:995:995"
      - "0.0.0.0:143:143"
      - "0.0.0.0:993:993"
      - "0.0.0.0:4190:4190"
    networks:
      default:
        ipv4_address: 192.168.203.10
      webmail:
    volumes:
      - "/mailu/certs:/certs"
      - "/mailu/overrides/nginx:/overrides:ro"

  admin:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}admin:${MAILU_VERSION:-2024.06}
    restart: always
    env_file: mailu.env
    environment:
      - SKIP_DNSSEC_CHECK=True
      - DNSSEC_VALIDATION=False
      - DNS_STRICT_DNSSEC=False
    dns:
      - 192.168.203.53
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - "/mailu/data:/data"
      - "/mailu/dkim:/dkim"
    depends_on:
      - redis
      - resolver

  imap:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}dovecot:${MAILU_VERSION:-2024.06}
    restart: always
    env_file: mailu.env
    environment:
      - TZ=Europe/Moscow
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    ports:
      # Пробрасываем порты IMAP напрямую для прямого доступа (альтернатива front)
      - "0.0.0.0:1143:143"
      - "0.0.0.0:1993:993"
    volumes:
      - "/mailu/mail:/mail"
      - "/mailu/overrides/dovecot:/overrides:ro"
    networks:
      - default
      - fts_attachments
    depends_on:
      - front
      - fts_attachments

  smtp:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}postfix:${MAILU_VERSION:-2024.06}
    restart: always
    env_file: mailu.env
    environment:
      - TZ=Europe/Moscow
    dns:
      - 192.168.203.53
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - "/mailu/mailqueue:/queue"
      - "/mailu/overrides/postfix:/overrides:ro"
    depends_on:
      - front

  # oletools отключен для упрощения
  # oletools:
  #   image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}oletools:${MAILU_VERSION:-2024.06}
  #   hostname: oletools
  #   logging:
  #     driver: json-file
  #     options:
  #       max-size: "10m"
  #       max-file: "3"
  #   restart: always
  #   networks:
  #     - oletools

  fts_attachments:
    image: apache/tika:latest-full
    hostname: tika
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    restart: always
    networks:
      - fts_attachments
    healthcheck:
      test: ["CMD-SHELL", "wget -nv -t1 -O /dev/null http://127.0.0.1:9998/tika || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  antispam:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}rspamd:${MAILU_VERSION:-2024.06}
    hostname: antispam
    restart: always
    env_file: mailu.env
    environment:
      - TZ=Europe/Moscow
    dns:
      - 192.168.203.53
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - default
    volumes:
      - "/mailu/filter:/var/lib/rspamd"
      - "/mailu/overrides/rspamd:/overrides:ro"
    depends_on:
      - front
      - redis

  # Optional services - антивирус отключен
  # antivirus:
  #   image: clamav/clamav-debian:1.4
  #   restart: always
  #   logging:
  #     driver: json-file
  #     options:
  #       max-size: "10m"
  #       max-file: "3"
  #   networks:
  #     - clamav
  #   volumes:
  #     - "/mailu/clamav:/var/lib/clamav"
  #   healthcheck:
  #     test: ["CMD-SHELL", "kill -0 `cat /tmp/clamd.pid` && kill -0 `cat /tmp/freshclam.pid`"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3
  #     start_period: 10s



  # Webmail
  webmail:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}webmail:${MAILU_VERSION:-2024.06}
    restart: always
    env_file: mailu.env
    environment:
      - TZ=Europe/Moscow
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - "/mailu/webmail:/data"
      - "/mailu/overrides/roundcube:/overrides:ro"
    networks:
      - webmail
    depends_on:
      - front

networks:
  default:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 192.168.203.0/24
  webmail:
    driver: bridge
  fts_attachments:
    driver: bridge
    internal: true
